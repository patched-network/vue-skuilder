name: Publish to NPM

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Yarn
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint packages
        run: |
          yarn workspace @vue-skuilder/common lint:check
          yarn workspace @vue-skuilder/db lint:check
          yarn workspace @vue-skuilder/express lint:check

      - name: Build packages in dependency order
        run: |
          echo "Building common package..."
          yarn workspace @vue-skuilder/common build
          
          echo "Building db package..."
          yarn workspace @vue-skuilder/db build
          
          echo "Building common-ui package..."
          yarn workspace @vue-skuilder/common-ui build
          
          echo "Building courses package..."
          yarn workspace @vue-skuilder/courses build
          
          echo "Building client package..."
          yarn workspace @vue-skuilder/client build
          
          echo "Building platform-ui package..."
          yarn workspace @vue-skuilder/platform-ui build
          
          echo "Building standalone-ui package..."
          yarn workspace @vue-skuilder/standalone-ui build
          
          echo "Building express package..."
          yarn workspace @vue-skuilder/express build

      - name: Verify build outputs
        run: |
          for package in common db common-ui courses client platform-ui standalone-ui express; do
            if [ ! -d "packages/$package/dist" ]; then
              echo "Error: dist directory not found for @vue-skuilder/$package"
              exit 1
            fi
            echo "âœ“ @vue-skuilder/$package build output verified"
          done

      - name: Publish packages in dependency order
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -e
          
          echo "Publishing @vue-skuilder/common..."
          cd packages/common && npm publish --access public
          
          echo "Publishing @vue-skuilder/db..."
          cd ../db && npm publish --access public
          
          echo "Publishing @vue-skuilder/common-ui..."
          cd ../common-ui && npm publish --access public
          
          echo "Publishing @vue-skuilder/courses..."
          cd ../courses && npm publish --access public
          
          echo "Publishing @vue-skuilder/client..."
          cd ../client && npm publish --access public
          
          echo "Publishing @vue-skuilder/platform-ui..."
          cd ../platform-ui && npm publish --access public
          
          echo "Publishing @vue-skuilder/standalone-ui..."
          cd ../standalone-ui && npm publish --access public
          
          echo "Publishing @vue-skuilder/express..."
          cd ../express && npm publish --access public
          
          echo "All packages published successfully!"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            Automated release for vue-skuilder packages
            
            Published packages:
            - @vue-skuilder/common
            - @vue-skuilder/db
            - @vue-skuilder/common-ui
            - @vue-skuilder/courses
            - @vue-skuilder/client
            - @vue-skuilder/platform-ui
            - @vue-skuilder/standalone-ui
            - @vue-skuilder/express
          draft: false
          prerelease: false